## DSF Develop

* [Allow List](#allow-list)
* [Process of updating the allow list](#process-of-updating-the-allow-list)
* [Ping Pong Test](#ping-pong-test)
* [Start DataSend](#start-datasend)
* [Configure json logging for DSF](#configure-json-logging-for-dsf)

---

### Allow List

Docs: https://dsf.dev/intro/info/allowList.html

In the `develop` namespace, we have the three DSF instances `diz`, `nth` and `crr`.
They share the same allow list in `/opt/fhir/conf/bundle.xml`.
With the

- Organizations:
  - netzwerk-universitaetsmedizin.de (parent Organization)
  - Test_DTS (nth)
  - Test_DIC (diz)
  - Test_CRR (crr)
- Endpoints:
  - Test_DTS_Endpoint https://nth-fhir.develop.rdp-dev.ingress.k8s.highmed.org/fhir
  - Test_DIC_Endpoint https://diz-fhir.develop.rdp-dev.ingress.k8s.highmed.org/fhir
  - Test_CRR_Endpoint https://crr-fhir.develop.rdp-dev.ingress.k8s.highmed.org/fhir
- OrganizationAffiliation:
  - Test_DTS_Endpoint has organization role DTS
  - Test_DIC_Endpoint has organization role DIC
  - Test_CRR_Endpoint has organization role CRR

The `bundle.xml` is generated by `create-bundle.sh` from the `hacks/allowlist` folder.
The `bundle.xml` is stored in a config map `bundle-xml` - see num-helm-charts `crr-fhir/templates/bundle-xml-config-map.yaml`

### Process of updating the allow list

Create new `bundle-xml` configMap:

- get new thumbprints from `[diz|nth|crr]-fhir` server logs
- add thumbprints values in `create-bundle.sh`
- execute `create-bundle.sh`
- copy the new `rdp-dev-bundle.xml` into the crr-fhir helm chart
- update the annotation on the configMap `bundele-xml`

After the deployment:

- check the configMap `bundele-xml` and restart Fhir servers and BPEs
- check logs of Fhir servers and BPEs

### Ping Pong Test

You need to inport a `.p12` cert into your browser to access the fhir server, see [How to prepare certs for DSF](#how-to-prepare-certs-for-dsf).

- Open `<baseUrl>/Task?_sort=_profile,identifier&status=draft` in the DSF FHIR UI, e.g.
  https://diz-fhir.develop.rdp-dev.ingress.k8s.highmed.org/fhir/Task?_sort=_profile,identifier&status=draft

- Click on the row with the message name `startPing`.
- Leave the input field target-endpoints empty and click on `Start Process`.
- The Task resource with a yellow info box will open --> Process in the status in-progress.
- Wait a few seconds to let the process complete.
- Reload the page and check the outputs.

### Start DataSend

You need to import a `.p12` cert into your browser to access the fhir server, see [How to prepare certs for DSF](#how-to-prepare-certs-for-dsf).

- Open `<baseUrl>/Task?_sort=_profile,identifier&status=draft` in the DSF FHIR UI, e.g.
  https://diz-fhir.develop.rdp-dev.ingress.k8s.highmed.org/fhir/Task?_sort=_profile,identifier&status=draft

- Click on the row with the message name `startDataSend` with Identifier `task-start-data-send-absolute-reference`.
- Add a patient reference to the patient field e. g. `http://develop-diz-hapi-fhir:8080/fhir/Patient/170`
- On dry-run click `No` and click on `Start Process`.
- The Task resource with a yellow info box will open --> Process in the status in-progress.
- Wait a few seconds to let the process complete.
- Reload the page and check the outputs.

### Configure json logging for DSF

To do this, overwrite / mount a custom Log4j2 configuration on the Log4j2 path in the container.

Here is an example of a customized Log4j2 configuration for the FHIR server:

```xml
<Configuration status="INFO" monitorInterval="30" verbose="false">
    <Appenders>
        <Console name="CONSOLE" target="SYSTEM_OUT">
            <JSONLayout compact="true" eventEol="true" properties="true" stacktraceAsString="true" includeTimeMillis="true" />
        </Console>
        <RollingFile name="FILE" fileName="log/bpe.log" filePattern="log/bpe_%d{yyyy-MM-dd}_%i.log.gz" ignoreExceptions="false">
            <PatternLayout>
                <Pattern>%d [%t] %-5p %c - %m%n</Pattern>
            </PatternLayout>
            <Policies>
                <OnStartupTriggeringPolicy />
                <TimeBasedTriggeringPolicy />
            </Policies>
        </RollingFile>
    </Appenders>
    <Loggers>
        <Logger name="dev.dsf" level="DEBUG" />
        <Logger name="de.netzwerk_universitaetsmedizin" level="DEBUG" />
        <Logger name="de.medizininformatik_initiative" level="DEBUG" />
        <Logger name="org.eclipse.jetty" level="INFO" />

        <Root level="WARN">
            <AppenderRef ref="CONSOLE" level="INFO" />
            <AppenderRef ref="FILE" level="DEBUG" />
        </Root>
    </Loggers>
</Configuration>
```

Mount this configfile in the fhir-server pod via configmap:

kubectl create configmap log4j2-config --from-file=log4j2.xml

```
    volumes:
      - name: log4j2-config
        configMap:
          name: log4j2-config
    volumeMounts:
      - name: log4j2-config
        mountPath: /opt/bpe/conf
```

The original Log4j2 configurations can be found here:
https://github.com/datasharingframework/dsf/blob/main/dsf-fhir/dsf-fhir-server-jetty/docker/conf/log4j2.xml
https://github.com/datasharingframework/dsf/blob/main/dsf-bpe/dsf-bpe-server-jetty/docker/conf/log4j2.xml

In the BPE, /opt/bpe/conf/log4j2.xml would have to be overwritten accordingly.

For the test I have just overwritten only the console logs (by `<JSONLayout compact=“true” eventEol=“true” properties=“true” stacktraceAsString=“true” includeTimeMillis=“true” />`)

Example log output:

```
{"timeMillis":1725603502386,"thread":"jetty-server-22","level":"INFO","loggerName":"dev.dsf.fhir.websocket.ServerEndpoint","message":"Websocket open, session 4e3021b5-a527-47d3-abd2-2b992c60a7a4, identity 'diz-test.gecko.hs-heilbronn.de'","endOfBatch":false,"loggerFqcn":"org.apache.logging.slf4j.Log4jLogger","contextMap":{},"threadId":22,"threadPriority":5}
```
